"use client";

import Link from "next/link";
import Image from "next/image";
import { useRouter } from "next/navigation";
import { useUser } from "@clerk/nextjs";
import { UserButton } from "@clerk/nextjs";
import { useEffect, useState } from "react";
import { useClerkSupabaseClient } from "@/lib/supabase/clerk-client";

const Navbar = () => {
  const { isSignedIn, isLoaded, user } = useUser();
  const router = useRouter();
  const supabase = useClerkSupabaseClient();
  const [isApprovedWholesaler, setIsApprovedWholesaler] = useState(false);
  const [isChecking, setIsChecking] = useState(true);

  // ìŠ¹ì¸ëœ ë„ë§¤ì‚¬ì—…ì ì—¬ë¶€ í™•ì¸
  useEffect(() => {
    const checkWholesalerStatus = async () => {
      if (!isLoaded || !isSignedIn || !user) {
        setIsApprovedWholesaler(false);
        setIsChecking(false);
        return;
      }

      try {
        console.log("ğŸ” [navbar] ë„ë§¤ì‚¬ì—…ì ìŠ¹ì¸ ìƒíƒœ í™•ì¸ ì‹œì‘");

        // í”„ë¡œí•„ ì¡°íšŒ (wholesalers ê´€ê³„ í¬í•¨)
        const { data: profile, error: profileError } = await supabase
          .from("profiles")
          .select("id, wholesalers(status)")
          .eq("clerk_user_id", user.id)
          .single();

        if (profileError || !profile) {
          console.log("âš ï¸ [navbar] í”„ë¡œí•„ ì—†ìŒ ë˜ëŠ” ì˜¤ë¥˜:", profileError);
          setIsApprovedWholesaler(false);
          setIsChecking(false);
          return;
        }

        // wholesalers ê´€ê³„ì—ì„œ ìŠ¹ì¸ ìƒíƒœ í™•ì¸
        const wholesalers = profile.wholesalers as Array<{
          status: string;
        }> | null;

        if (wholesalers && wholesalers.length > 0) {
          const wholesaler = wholesalers[0];
          const isApproved = wholesaler.status === "approved";

          console.log("âœ… [navbar] ë„ë§¤ì‚¬ì—…ì ìƒíƒœ:", {
            status: wholesaler.status,
            isApproved,
          });

          setIsApprovedWholesaler(isApproved);
        } else {
          setIsApprovedWholesaler(false);
        }
      } catch (error) {
        console.error("âŒ [navbar] ë„ë§¤ì‚¬ì—…ì ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:", error);
        setIsApprovedWholesaler(false);
      } finally {
        setIsChecking(false);
      }
    };

    checkWholesalerStatus();
  }, [isLoaded, isSignedIn, user, supabase]);

  // ë¡œê³  í´ë¦­ í•¸ë“¤ëŸ¬
  const handleLogoClick = (e: React.MouseEvent<HTMLAnchorElement>) => {
    e.preventDefault();

    // ìŠ¹ì¸ëœ ë„ë§¤ì‚¬ì—…ìì¸ ê²½ìš° ëŒ€ì‹œë³´ë“œë¡œ ì´ë™
    if (isApprovedWholesaler) {
      console.log("âœ… [navbar] ìŠ¹ì¸ëœ ë„ë§¤ì‚¬ì—…ì, ëŒ€ì‹œë³´ë“œë¡œ ì´ë™");
      router.push("/wholesaler");
    } else {
      console.log("â„¹ï¸ [navbar] ì¼ë°˜ ì‚¬ìš©ì, í™ˆìœ¼ë¡œ ì´ë™");
      router.push("/");
    }
  };

  return (
    <header className="flex justify-between items-center p-4 gap-4 h-16 max-w-7xl mx-auto">
      <Link
        href={isApprovedWholesaler ? "/wholesaler" : "/"}
        onClick={handleLogoClick}
        className="flex items-center gap-2"
      >
        <Image
          src="/logo.png"
          alt="FarmToBiz"
          width={32}
          height={32}
          className="object-contain"
        />
        <span className="text-2xl font-bold text-green-600">FarmToBiz</span>
      </Link>

      {/* ë¡œê·¸ì¸ ìƒíƒœì— ë”°ë¼ ì‚¬ìš©ì ì •ë³´ í‘œì‹œ */}
      {isLoaded && (
        <div className="flex items-center gap-3">
          {isSignedIn ? (
            <>
              {/* ë¡œê·¸ì¸ ìƒíƒœ í‘œì‹œ */}
              <div className="flex items-center gap-2 text-sm text-gray-600">
                <span className="hidden sm:inline">ë¡œê·¸ì¸ë¨</span>
                {user?.primaryEmailAddress?.emailAddress && (
                  <span className="hidden md:inline text-gray-500">
                    ({user.primaryEmailAddress.emailAddress})
                  </span>
                )}
              </div>
              <UserButton
                afterSignOutUrl="/"
                appearance={{
                  elements: {
                    avatarBox: "w-8 h-8",
                  },
                }}
              />
            </>
          ) : (
            <div className="flex items-center gap-2">
              <span className="text-sm text-gray-500">ë¡œê·¸ì¸ë˜ì§€ ì•ŠìŒ</span>
            </div>
          )}
        </div>
      )}
    </header>
  );
};

export default Navbar;
